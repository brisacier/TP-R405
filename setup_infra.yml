---
- name: setup DNS servers 
  hosts: dns
  remote_user: root
  tasks:
    - name: Install bind9 (or update to latest version)
      ansible.builtin.package:
        name: bind9
        state: latest
    - name: get timestamp on 1 server for serial number
      ansible.builtin.shell:
        cmd: "date +%s"
      run_once: True
      register: timestamp
    - name: generate zone file from jinja2 template and copy it on server
      ansible.builtin.template:
        src: templates/labzone.j2
        dest: /etc/bind/db.{{ domaine_lab }}
        owner: bind
        group: bind
        mode: '0644'
    - name: edit named.conf.local file to add zone file
      ansible.builtin.blockinfile: 
        path: /etc/bind/named.conf.local
        backup: true
        block : |
          zone "{{ domaine_lab }}" {
            type master;
            file "/etc/bind/db.{{ domaine_lab }}";
          };
    - name: reload bind service
      ansible.builtin.service:
        name: bind9
        state: restarted

- name: edit DNS parameters to match DNS VM servers
  hosts: web:lb
  tasks:
  - name: Include task set_dns in play
    ansible.builtin.import_tasks:
      file: tasks/set_dns.yml

- name: setup web load balancer
  hosts: lb
  tasks:
  - name: install apache2 on lb machine
    ansible.builtin.package:
      name: apache2
      state: latest
  - name: enable apache2 modules
    community.general.apache2_module:
      state: present
      name: "{{ item }}"
    loop:
      - proxy_http
      - proxy_http2
      - proxy_balancer
      - lbmethod_byrequests
  - name: generate apache2 config from jinja2 template and copy it on server
    ansible.builtin.template:
      src: templates/lb-apache-conf.j2
      dest: /etc/apache2/sites-available/000-default.conf
      owner: www-data
      group: www-data
      mode: '0644'
    register: template_state
  - name: reload apache2 service
    ansible.builtin.service:
      name: apache2
      state: restarted
    when: template_state.changed


- name: setup web servers
  hosts: web
  tasks:
  - name: install apache2 and php
    ansible.builtin.package:
      name: 
        - apache2
        - php
      state: latest
  - name: remove default index file
    ansible.builtin.file:
      path: /var/www/html/index.html
      state: absent

  - name: copy index.php from project to web servers
    ansible.builtin.copy:
      src: files/index.php
      dest: /var/www/html/index.php
      owner: www-data
      group: www-data
      mode: '0644'